generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  // Tier 1: Operators (Department-specific, job-based access)
  Operator

  // Tier 2: Management (Extended functions within departments)
  Supervisor
  Inventory
  Purchasing
  Maintenance
  QC

  // Tier 3: Sales (Sales Pit access only)
  Sales

  // Tier 4: Engineering (Inventory view + job submission)
  Engineering

  // Tier 5: Executive (Full control within their tenant/warehouse)
  Admin
  Executive

  // Tier 6: Super Admin (Platform owner - manages ALL tenants)
  SuperAdmin

  // Legacy/Limited
  Viewer
}

enum Uom {
  EA
  FT
  YD
  ROLL
}

enum ItemCategory {
  PRODUCTION
  PACKAGING
  FACILITY
  CHEMICAL_MRO
}

enum LocationType {
  RECEIVING
  STOCK
  WIP
  QC_HOLD
  SHIPPING
}

enum ReasonType {
  SCRAP
  ADJUST
  HOLD
}

enum InventoryEventType {
  RECEIVE
  MOVE
  ISSUE_TO_WORKCELL
  RETURN
  SCRAP
  HOLD
  RELEASE
  COUNT
  ADJUST
}

enum CycleCountStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CycleCountType {
  FULL
  ABC
  RANDOM
  LOCATION
  ITEM
}

enum CountLineStatus {
  PENDING
  COUNTED
  VARIANCE_APPROVED
  VARIANCE_REJECTED
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum POLineStatus {
  PENDING
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum BOMStatus {
  DRAFT
  ACTIVE
  INACTIVE
  SUPERSEDED
}

enum ProductionOrderStatus {
  PLANNED
  RELEASED
  IN_PROGRESS
  COMPLETED
  CLOSED
  CANCELLED
}

enum SalesOrderStatus {
  DRAFT
  CONFIRMED
  ALLOCATED
  PICKING
  PACKED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum SOLineStatus {
  OPEN
  ALLOCATED
  PICKING
  PICKED
  PACKED
  SHIPPED
  CANCELLED
}

enum ShipmentStatus {
  DRAFT
  READY_TO_SHIP
  SHIPPED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum ComponentIssueMethod {
  MANUAL
  BACKFLUSH
  PREISSUE
}

// ============================================================
// MULTI-TENANT & ORGANIZATIONAL STRUCTURE
// ============================================================

// ============================================================
// SAAS SUBSCRIPTION & BILLING
// ============================================================

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  PAUSED
}

enum PlanTier {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

model Plan {
  id                  String          @id @default(uuid())
  name                String          // "Starter", "Professional", "Enterprise"
  tier                PlanTier        @unique
  description         String?
  
  // Pricing (null for custom/enterprise pricing)
  monthlyPrice        Float?          // Price in dollars (null = custom pricing)
  yearlyPrice         Float?          // Price for annual billing (discounted)
  currency            String          @default("USD")
  
  // Limits (null for unlimited)
  maxUsers            Int?            // null for unlimited
  maxSites            Int?
  maxItems            Int?            // SKUs
  maxStorageGb        Float?          // File storage limit
  maxApiCallsPerMonth Int?            // Rate limiting
  
  // Features
  features            String[]        // Array of feature keys
  enabledModules      String[]        // Which modules are included
  
  // Stripe
  stripeMonthlyPriceId String?        // Stripe Price ID for monthly
  stripeYearlyPriceId  String?        // Stripe Price ID for yearly
  
  isActive            Boolean         @default(true)
  isPublic            Boolean         @default(true) // Show on pricing page
  sortOrder           Int             @default(0)
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  // Relations
  subscriptions       Subscription[]
  
  @@index([tier])
  @@index([isActive, isPublic])
}

model Subscription {
  id                  String             @id @default(uuid())
  tenantId            String             @unique
  planId              String
  status              SubscriptionStatus @default(TRIALING)
  
  // Billing
  billingInterval     BillingInterval    @default(MONTHLY)
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  cancelAtPeriodEnd   Boolean            @default(false)
  canceledAt          DateTime?
  
  // Trial
  trialStart          DateTime?
  trialEnd            DateTime?
  
  // Stripe
  stripeCustomerId    String?            @unique
  stripeSubscriptionId String?           @unique
  
  // Usage tracking
  usersCount          Int                @default(0)
  sitesCount          Int                @default(0)
  itemsCount          Int                @default(0)
  storageUsedGb       Float              @default(0)
  apiCallsThisMonth   Int                @default(0)
  
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  
  // Relations
  tenant              Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan                Plan               @relation(fields: [planId], references: [id])
  invoices            Invoice[]
  usageRecords        UsageRecord[]
  
  @@index([tenantId])
  @@index([planId])
  @@index([status])
  @@index([stripeCustomerId])
}

model Invoice {
  id                  String    @id @default(uuid())
  subscriptionId      String
  
  // Amount
  amountDue           Float     // In smallest currency unit (cents)
  amountPaid          Float     @default(0)
  currency            String    @default("USD")
  
  // Status
  status              String    // draft, open, paid, void, uncollectible
  dueDate             DateTime?
  paidAt              DateTime?
  
  // Stripe
  stripeInvoiceId     String?   @unique
  stripeInvoiceUrl    String?   // Hosted invoice URL
  stripePdfUrl        String?   // PDF download URL
  
  // Period
  periodStart         DateTime
  periodEnd           DateTime
  
  // Line items stored as JSON
  lineItems           Json?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  subscription        Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([status])
  @@index([stripeInvoiceId])
}

model UsageRecord {
  id              String   @id @default(uuid())
  subscriptionId  String
  
  // What was used
  metricName      String   // "api_calls", "storage_gb", "users", etc.
  quantity        Float
  
  // When
  recordedAt      DateTime @default(now())
  periodStart     DateTime
  periodEnd       DateTime
  
  // Metadata
  metadata        Json?
  
  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId, metricName])
  @@index([recordedAt])
}

// ============================================================
// TENANT & ORGANIZATION
// ============================================================

model Tenant {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  enabledModules  String[]
  defaultCurrency String   @default("USD") // ISO 4217 currency code
  locale          String   @default("en-US") // Locale for formatting

  // Onboarding
  onboardingCompleted Boolean  @default(false)
  onboardingStep      Int      @default(0)

  // Contact
  contactEmail    String?
  contactPhone    String?
  website         String?

  // Address
  address1        String?
  address2        String?
  city            String?
  state           String?
  postalCode      String?
  country         String?

  // Branding (Enhanced)
  logoUrl         String?
  primaryColor    String?
  brandLogo       String?         // Enhanced logo field
  brandColor      String?         // Primary brand color hex
  brandColorSecondary String?     // Secondary brand color
  favicon         String?         // Custom favicon URL
  customCSS       String?         @db.Text // Custom CSS for advanced branding

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  subscription      Subscription?
  settings          TenantSettings?
  userAccess        UserTenantAccess[]
  sites             Site[]
  users             User[]
  departments       Department[]
  workcells         Workcell[]
  devices           Device[]
  badges            Badge[]
  auditEvents       AuditEvent[]
  items             Item[]
  locations         Location[]
  reasonCodes       ReasonCode[]
  inventoryEvents   InventoryEvent[]
  inventoryBalances InventoryBalance[]
  cycleCounts       CycleCount[]
  cycleCountLines   CycleCountLine[]
  jobs              Job[]
  suppliers         Supplier[]
  purchaseOrders    PurchaseOrder[]
  receipts          Receipt[]
  billsOfMaterial   BillOfMaterial[]
  productionOrders  ProductionOrder[]
  notifications     Notification[]
  customers         Customer[]
  salesOrders       SalesOrder[]
  shipments         Shipment[]
  pickTasks         PickTask[]
  customDepartments CustomDepartment[]
  productionRoutings ProductionRouting[]
  workflowRules     WorkflowRule[]
  lots              Lot[]
  serialNumbers     SerialNumber[]
  qualityInspections QualityInspection[]
  qualityInspectionPlans QualityInspectionPlan[]
  ncrs              NonConformanceReport[]
  capas             CAPA[]
}

// Multi-company access control
model UserTenantAccess {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  role      Role     // Role can differ per tenant
  isDefault Boolean  @default(false) // User's default tenant

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

// Company-specific settings
model TenantSettings {
  id                String   @id @default(uuid())
  tenantId          String   @unique

  // Regional settings
  currency          String   @default("USD")
  locale            String   @default("en-US")
  timezone          String   @default("America/New_York")
  dateFormat        String   @default("MM/DD/YYYY")
  timeFormat        String   @default("12h") // 12h or 24h

  // Business settings
  fiscalYearStart   Int      @default(1) // Month 1-12
  workWeekDays      Int[]    // [1,2,3,4,5] = Mon-Fri
  defaultUOM        String   @default("EA")

  // Workflow settings
  requirePOApproval Boolean  @default(true)
  poApprovalLimit   Float?   // POs over this amount require approval
  autoReceivePos    Boolean  @default(false)
  autoReleasePOs    Boolean  @default(false)

  // Manufacturing settings
  defaultLeadTime   Int      @default(7) // Default lead time in days
  allowNegativeInventory Boolean @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Site {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departments       Department[]
  workcells         Workcell[]
  devices           Device[]
  locations         Location[]
  inventoryEvents   InventoryEvent[]
  inventoryBalances InventoryBalance[]
  cycleCounts       CycleCount[]
  cycleCountLines   CycleCountLine[]
  jobs              Job[]
  purchaseOrders    PurchaseOrder[]
  receipts          Receipt[]
  productionOrders  ProductionOrder[]
  salesOrders       SalesOrder[]
  shipments         Shipment[]
  pickTasks         PickTask[]

  @@index([tenantId])
}

model Department {
  id        String   @id @default(uuid())
  tenantId  String
  siteId    String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site      Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  workcells Workcell[]

  @@index([tenantId])
  @@index([siteId])
}

model Workcell {
  id           String   @id @default(uuid())
  tenantId     String
  siteId       String
  departmentId String?
  name         String
  description  String?
  status       String   @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department      Department?      @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  devices         Device[]
  inventoryEvents InventoryEvent[]
  jobs            Job[]
  productionOrders ProductionOrder[]

  @@index([tenantId])
  @@index([siteId])
  @@index([departmentId])
}

model Device {
  id           String   @id @default(uuid())
  tenantId     String
  siteId       String
  workcellId   String?
  name         String
  type         String
  serialNumber String?
  status       String   @default("online")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  workcell        Workcell?        @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  inventoryEvents InventoryEvent[]

  @@index([tenantId])
  @@index([siteId])
  @@index([workcellId])
}

// ============================================================
// USERS & AUTHENTICATION
// ============================================================

model User {
  id        String   @id @default(uuid())
  tenantId  String
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(Viewer)
  siteIds   String[]

  // Department/Workcell assignment for operators
  assignedDepartments String[] @default([]) // For operators - which departments they work in
  assignedWorkcells   String[] @default([]) // For operators - specific workcells

  // Super Admin flag - platform owner access
  isSuperAdmin Boolean  @default(false) // Can manage ALL tenants

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant                  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantAccess            UserTenantAccess[] // Multi-company access
  badges                  Badge[]
  auditEvents             AuditEvent[]
  inventoryEvents         InventoryEvent[]
  cycleCountsCreated      CycleCount[]     @relation("CycleCountCreatedBy")
  cycleCountsAssigned     CycleCount[]     @relation("CycleCountAssignedTo")
  cycleCountLinesCounted  CycleCountLine[] @relation("CountedBy")
  cycleCountLinesApproved CycleCountLine[] @relation("ApprovedBy")
  jobsAssigned            Job[]            @relation("AssignedJobs")
  jobsCreated             Job[]            @relation("CreatedJobs")
  jobLinesCompleted       JobLine[]        @relation("JobLineCompletedBy")
  purchaseOrdersCreated   PurchaseOrder[]  @relation("POCreatedBy")
  purchaseOrdersApproved  PurchaseOrder[]  @relation("POApprovedBy")
  bomsCreated             BillOfMaterial[] @relation("BOMCreatedBy")
  bomsApproved            BillOfMaterial[] @relation("BOMApprovedBy")
  productionOrdersCreated ProductionOrder[] @relation("ProductionOrderCreatedBy")
  productionOrdersReleased ProductionOrder[] @relation("ProductionOrderReleasedBy")
  consumptionsCreated     ProductionConsumption[] @relation("ConsumptionCreatedBy")
  outputsCreated          ProductionOutput[] @relation("OutputCreatedBy")
  salesOrdersCreated      SalesOrder[]       @relation("SOCreatedBy")
  salesOrdersApproved     SalesOrder[]       @relation("SOApprovedBy")
  pickTasksAssigned       PickTask[]         @relation("PickTaskAssignedTo")
  pickTasksCompleted      PickTask[]         @relation("PickTaskCompletedBy")
  pickTaskLinesCompleted  PickTaskLine[]     @relation("PickLineCompletedBy")
  shipmentsCreated        Shipment[]
  productionOrderNotes    ProductionOrderNote[]

  @@index([tenantId])
  @@index([email])
}

model Badge {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String
  badgeNumber String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, badgeNumber])
  @@index([tenantId])
  @@index([userId])
}

// ============================================================
// AUDIT TRAIL
// ============================================================

model AuditEvent {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String
  entityType String
  entityId   String?
  details    String?
  ipAddress  String?
  timestamp  DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([timestamp])
  @@index([entityType, entityId])
}

// ============================================================
// INVENTORY MODULE
// ============================================================

model Item {
  id               String       @id @default(uuid())
  tenantId         String
  sku              String
  name             String
  description      String?
  category         ItemCategory
  baseUom          Uom
  allowedUoms      Json // Array of {uom: Uom, toBase: number}
  minQtyBase       Float?
  maxQtyBase       Float?
  reorderPointBase Float?
  leadTimeDays     Int?

  // Cost tracking fields
  costBase         Float?       // Standard cost per base UOM
  avgCostBase      Float?       // Weighted average cost (auto-calculated)
  lastCostBase     Float?       // Most recent purchase cost

  // Barcode fields
  barcode          String?      // Primary barcode
  barcodeType      String?      // EAN-13, UPC-A, CODE-128, etc
  alternateBarcode String?      // Secondary barcode

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventoryEvents   InventoryEvent[]
  balances          InventoryBalance[]
  cycleCountLines   CycleCountLine[]
  jobLines          JobLine[]
  purchaseOrderLines PurchaseOrderLine[]
  receiptLines      ReceiptLine[]
  boms              BillOfMaterial[]    @relation("BOMFinishedGood")
  bomComponents     BOMComponent[]      @relation("BOMComponentItem")
  productionOrders  ProductionOrder[]   @relation("ProductionOrderItem")
  consumptions      ProductionConsumption[] @relation("ConsumptionItem")
  outputs           ProductionOutput[]  @relation("OutputItem")
  componentScans    ComponentScan[]
  salesOrderLines   SalesOrderLine[]
  shipmentLines     ShipmentLine[]
  pickTaskLines     PickTaskLine[]
  productionRoutings ProductionRouting[]
  lots              Lot[]               @relation("LotItem")
  serialNumbers     SerialNumber[]      @relation("SerialItem")
  qualityInspections QualityInspection[] @relation("InspectionItem")
  qualityInspectionPlans QualityInspectionPlan[] @relation("InspectionPlanItem")
  ncrs              NonConformanceReport[] @relation("NCRItem")

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([name])
}

model Location {
  id        String        @id @default(uuid())
  tenantId  String
  siteId    String
  zone      String?
  bin       String?
  label     String
  type      LocationType?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site               @relation(fields: [siteId], references: [id], onDelete: Cascade)
  fromEvents      InventoryEvent[]   @relation("FromLocation")
  toEvents        InventoryEvent[]   @relation("ToLocation")
  balances        InventoryBalance[]
  cycleCountLines CycleCountLine[]
  jobLinesFrom    JobLine[]          @relation("JobLineFromLocation")
  jobLinesTo      JobLine[]          @relation("JobLineToLocation")
  receipts        Receipt[]
  consumptions    ProductionConsumption[] @relation("ConsumptionLocation")
  outputs         ProductionOutput[] @relation("OutputLocation")
  pickTaskLinesFrom    PickTaskLine[]     @relation("PickFromLocation")
  pickTaskLinesActual  PickTaskLine[]     @relation("ActualPickLocation")
  serialNumbers        SerialNumber[]     @relation("SerialLocation")

  @@unique([tenantId, siteId, label])
  @@index([tenantId])
  @@index([siteId])
}

model ReasonCode {
  id          String     @id @default(uuid())
  tenantId    String
  type        ReasonType
  code        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventoryEvents InventoryEvent[]
  consumptions    ProductionConsumption[]
  lotHolds        Lot[]            @relation("LotHoldReason")

  @@unique([tenantId, type, code])
  @@index([tenantId])
}

model InventoryEvent {
  id              String             @id @default(uuid())
  tenantId        String
  siteId          String
  eventType       InventoryEventType
  itemId          String
  qtyEntered      Float
  uomEntered      Uom
  qtyBase         Float
  fromLocationId  String?
  toLocationId    String?
  workcellId      String?
  referenceId     String?
  reasonCodeId    String?
  notes           String?
  createdByUserId String?
  deviceId        String?
  createdAt       DateTime           @default(now())

  // Relations
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site         Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  item         Item        @relation(fields: [itemId], references: [id], onDelete: Restrict)
  fromLocation Location?   @relation("FromLocation", fields: [fromLocationId], references: [id], onDelete: Restrict)
  toLocation   Location?   @relation("ToLocation", fields: [toLocationId], references: [id], onDelete: Restrict)
  workcell     Workcell?   @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  reasonCode   ReasonCode? @relation(fields: [reasonCodeId], references: [id], onDelete: SetNull)
  createdBy    User?       @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  device       Device?     @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([siteId])
  @@index([itemId])
  @@index([createdAt])
  @@index([eventType])                       // For filtering by event type
  @@index([tenantId, createdAt(sort: Desc)]) // For dashboard queries
  @@index([itemId, eventType])               // For inventory aging queries
}

model InventoryBalance {
  id         String   @id @default(uuid())
  tenantId   String
  siteId     String
  itemId     String
  locationId String
  qtyBase    Float
  updatedAt  DateTime @updatedAt

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site     Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([tenantId, itemId, locationId])
  @@index([tenantId])
  @@index([siteId])
  @@index([itemId])
  @@index([locationId])
}

// ============================================================
// CYCLE COUNTS MODULE
// ============================================================

model CycleCount {
  id               String           @id @default(uuid())
  tenantId         String
  siteId           String
  name             String
  type             CycleCountType
  status           CycleCountStatus @default(SCHEDULED)
  scheduledDate    DateTime
  startedAt        DateTime?
  completedAt      DateTime?
  assignedToUserId String?
  notes            String?
  createdByUserId  String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  tenant     Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdBy  User             @relation("CycleCountCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  assignedTo User?            @relation("CycleCountAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  lines      CycleCountLine[]

  @@index([tenantId])
  @@index([siteId])
  @@index([status])
  @@index([scheduledDate])
}

model CycleCountLine {
  id               String          @id @default(uuid())
  cycleCountId     String
  tenantId         String
  siteId           String
  itemId           String
  locationId       String
  expectedQtyBase  Float
  countedQtyBase   Float?
  varianceQtyBase  Float?
  status           CountLineStatus @default(PENDING)
  countedByUserId  String?
  countedAt        DateTime?
  approvedByUserId String?
  approvedAt       DateTime?
  notes            String?

  // Relations
  cycleCount CycleCount @relation(fields: [cycleCountId], references: [id], onDelete: Cascade)
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  item       Item       @relation(fields: [itemId], references: [id], onDelete: Restrict)
  location   Location   @relation(fields: [locationId], references: [id], onDelete: Restrict)
  countedBy  User?      @relation("CountedBy", fields: [countedByUserId], references: [id], onDelete: SetNull)
  approvedBy User?      @relation("ApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)

  @@index([cycleCountId])
  @@index([tenantId])
  @@index([siteId])
  @@index([itemId])
  @@index([locationId])
  @@index([status])
}

// ============================================================
// JOBS MODULE (Placeholder for future implementation)
// ============================================================

model Job {
  id               String    @id @default(uuid())
  tenantId         String
  siteId           String
  workcellId       String?
  routingId        String?   // Production routing for this job
  jobNumber        String
  description      String?
  type             String?
  status           String    @default("PENDING")
  assignedToUserId String?
  createdByUserId  String?
  scheduledDate    DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  tenant     Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site               @relation(fields: [siteId], references: [id], onDelete: Cascade)
  workcell   Workcell?          @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  routing    ProductionRouting? @relation(fields: [routingId], references: [id], onDelete: SetNull)
  assignedTo User?              @relation("AssignedJobs", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  createdBy  User?              @relation("CreatedJobs", fields: [createdByUserId], references: [id], onDelete: SetNull)
  lines      JobLine[]

  @@unique([tenantId, jobNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([status])
  @@index([assignedToUserId])
  @@index([routingId])
}

model JobLine {
  id                String    @id @default(uuid())
  jobId             String
  itemId            String
  qtyOrdered        Float
  qtyCompleted      Float     @default(0)
  qtyBase           Float
  fromLocationId    String?
  toLocationId      String?
  status            String    @default("PENDING")
  notes             String?
  completedByUserId String?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  job          Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  item         Item      @relation(fields: [itemId], references: [id], onDelete: Restrict)
  fromLocation Location? @relation("JobLineFromLocation", fields: [fromLocationId], references: [id], onDelete: SetNull)
  toLocation   Location? @relation("JobLineToLocation", fields: [toLocationId], references: [id], onDelete: SetNull)
  completedBy  User?     @relation("JobLineCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([itemId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@index([completedByUserId])
}

// ============================================================
// PURCHASING MODULE
// ============================================================

model Supplier {
  id              String   @id @default(uuid())
  tenantId        String
  code            String
  name            String
  contactName     String?
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  paymentTerms    String?
  leadTimeDays    Int?
  isActive        Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  lots           Lot[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([name])
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  tenantId         String
  siteId           String
  supplierId       String
  poNumber         String
  status           PurchaseOrderStatus @default(DRAFT)
  orderDate        DateTime
  expectedDelivery DateTime?
  notes            String?
  subtotal         Float               @default(0)
  tax              Float               @default(0)
  shipping         Float               @default(0)
  total            Float               @default(0)
  createdByUserId  String?
  approvedByUserId String?
  approvedAt       DateTime?
  sentAt           DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Relations
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)
  supplier   Supplier          @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  createdBy  User?             @relation("POCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedBy User?             @relation("POApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  lines      PurchaseOrderLine[]
  receipts   Receipt[]
  qualityInspections QualityInspection[] @relation("InspectionPurchaseOrder")

  @@unique([tenantId, poNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

model PurchaseOrderLine {
  id               String        @id @default(uuid())
  purchaseOrderId  String
  itemId           String
  lineNumber       Int
  description      String?
  qtyOrdered       Float
  qtyReceived      Float         @default(0)
  uom              Uom
  unitPrice        Float
  lineTotal        Float
  status           POLineStatus  @default(PENDING)
  expectedDelivery DateTime?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  purchaseOrder PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item            @relation(fields: [itemId], references: [id], onDelete: Restrict)
  receiptLines  ReceiptLine[]

  @@index([purchaseOrderId])
  @@index([itemId])
  @@index([status])
}

model Receipt {
  id              String    @id @default(uuid())
  tenantId        String
  siteId          String
  purchaseOrderId String
  receiptNumber   String
  receiptDate     DateTime
  receivedBy      String?
  locationId      String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site          Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)
  purchaseOrder PurchaseOrder     @relation(fields: [purchaseOrderId], references: [id], onDelete: Restrict)
  location      Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  lines         ReceiptLine[]

  @@unique([tenantId, receiptNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([purchaseOrderId])
  @@index([receiptDate])
}

model ReceiptLine {
  id                  String    @id @default(uuid())
  receiptId           String
  purchaseOrderLineId String
  itemId              String
  qtyReceived         Float
  uom                 Uom
  notes               String?
  createdAt           DateTime  @default(now())

  // Relations
  receipt           Receipt           @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  purchaseOrderLine PurchaseOrderLine @relation(fields: [purchaseOrderLineId], references: [id], onDelete: Restrict)
  item              Item              @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([receiptId])
  @@index([purchaseOrderLineId])
  @@index([itemId])
}

// ============================================================
// MANUFACTURING & BILL OF MATERIALS
// ============================================================

model BillOfMaterial {
  id              String      @id @default(uuid())
  tenantId        String
  itemId          String
  bomNumber       String
  version         Int         @default(1)
  description     String?
  status          BOMStatus   @default(DRAFT)

  // Quantities
  baseQty         Float       @default(1)
  baseUom         Uom         @default(EA)

  // Effectivity
  effectiveFrom   DateTime    @default(now())
  effectiveTo     DateTime?

  // Metadata
  notes           String?
  createdByUserId String?
  approvedByUserId String?
  approvedAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  tenant          Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item            Item                 @relation("BOMFinishedGood", fields: [itemId], references: [id], onDelete: Restrict)
  createdBy       User?                @relation("BOMCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedBy      User?                @relation("BOMApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  components      BOMComponent[]
  productionOrders ProductionOrder[]

  @@unique([tenantId, bomNumber, version])
  @@index([tenantId])
  @@index([itemId])
  @@index([status])
}

model BOMComponent {
  id              String      @id @default(uuid())
  bomId           String
  itemId          String
  sequence        Int

  // Quantities
  qtyPer          Float
  uom             Uom
  scrapFactor     Float       @default(0)

  // Planning
  isOptional      Boolean     @default(false)
  isPurchased     Boolean     @default(false)
  leadTimeOffset  Int?        @default(0)

  // Issue method
  issueMethod     ComponentIssueMethod @default(BACKFLUSH)

  // Metadata
  notes           String?
  referenceDesignator String?

  // Relations
  bom             BillOfMaterial @relation(fields: [bomId], references: [id], onDelete: Cascade)
  item            Item           @relation("BOMComponentItem", fields: [itemId], references: [id], onDelete: Restrict)
  consumptions    ProductionConsumption[]

  @@index([bomId])
  @@index([itemId])
  @@unique([bomId, sequence])
}

model ProductionOrder {
  id                String                @id @default(uuid())
  tenantId          String
  siteId            String
  bomId             String
  orderNumber       String
  status            ProductionOrderStatus @default(PLANNED)

  // What to produce
  itemId            String
  qtyOrdered        Float
  qtyCompleted      Float                 @default(0)
  qtyRejected       Float                 @default(0)
  uom               Uom

  // When
  scheduledStart    DateTime
  scheduledEnd      DateTime?
  actualStart       DateTime?
  actualEnd         DateTime?

  // Where
  workcellId        String?

  // Lot/Batch tracking
  lotNumber         String?
  batchNumber       String?

  // Metadata
  priority          Int                   @default(5)
  notes             String?
  createdByUserId   String?
  releasedByUserId  String?
  releasedAt        DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  // Relations
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site              Site                  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  bom               BillOfMaterial        @relation(fields: [bomId], references: [id], onDelete: Restrict)
  item              Item                  @relation("ProductionOrderItem", fields: [itemId], references: [id], onDelete: Restrict)
  workcell          Workcell?             @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  createdBy         User?                 @relation("ProductionOrderCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  releasedBy        User?                 @relation("ProductionOrderReleasedBy", fields: [releasedByUserId], references: [id], onDelete: SetNull)
  consumptions      ProductionConsumption[]
  outputs           ProductionOutput[]
  jobOperations     JobOperation[]
  scanEvents        OperationScanEvent[]
  componentScans    ComponentScan[]
  lots              Lot[]               @relation("LotProductionOrder")
  qualityInspections QualityInspection[] @relation("InspectionProductionOrder")
  ncrs              NonConformanceReport[] @relation("NCRProductionOrder")
  operatorNotes     ProductionOrderNote[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([bomId])
  @@index([itemId])
  @@index([status])
  @@index([scheduledStart])
}

// Notes on production orders (for mobile operator tracking)
model ProductionOrderNote {
  id                String          @id @default(uuid())
  productionOrderId String
  content           String
  noteType          String          @default("info") // info, issue, part_replacement
  createdById       String
  createdAt         DateTime        @default(now())

  // Relations
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  createdBy         User            @relation(fields: [createdById], references: [id], onDelete: Restrict)

  @@index([productionOrderId])
  @@index([noteType])
  @@index([createdAt])
}

model ProductionConsumption {
  id                    String          @id @default(uuid())
  productionOrderId     String
  bomComponentId        String?
  itemId                String

  // Quantities
  qtyConsumed           Float
  uom                   Uom
  qtyBase               Float

  // Source
  fromLocationId        String
  lotNumber             String?
  serialNumber          String?

  // Tracking
  isBackflushed         Boolean         @default(false)
  isScrap               Boolean         @default(false)
  reasonCodeId          String?

  // Reference
  referenceId           String?
  notes                 String?
  createdByUserId       String?
  createdAt             DateTime        @default(now())

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  bomComponent          BOMComponent?   @relation(fields: [bomComponentId], references: [id], onDelete: SetNull)
  item                  Item            @relation("ConsumptionItem", fields: [itemId], references: [id], onDelete: Restrict)
  fromLocation          Location        @relation("ConsumptionLocation", fields: [fromLocationId], references: [id], onDelete: Restrict)
  reasonCode            ReasonCode?     @relation(fields: [reasonCodeId], references: [id], onDelete: SetNull)
  createdBy             User?           @relation("ConsumptionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([productionOrderId])
  @@index([itemId])
  @@index([fromLocationId])
}

model ProductionOutput {
  id                    String          @id @default(uuid())
  productionOrderId     String
  itemId                String

  // Quantities
  qtyProduced           Float
  qtyRejected           Float           @default(0)
  uom                   Uom
  qtyBase               Float

  // Destination
  toLocationId          String
  lotNumber             String?
  batchNumber           String?
  expirationDate        DateTime?

  // Quality
  inspectionStatus      String?

  // Reference
  referenceId           String?
  notes                 String?
  createdByUserId       String?
  createdAt             DateTime        @default(now())

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  item                  Item            @relation("OutputItem", fields: [itemId], references: [id], onDelete: Restrict)
  toLocation            Location        @relation("OutputLocation", fields: [toLocationId], references: [id], onDelete: Restrict)
  createdBy             User?           @relation("OutputCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([productionOrderId])
  @@index([itemId])
  @@index([toLocationId])
}
// Job Tracking Models

model JobOperation {
  id                    String          @id @default(uuid())
  productionOrderId     String
  sequence              Int
  department            String
  operationName         String
  description           String?
  status                String          @default("PENDING") // PENDING, IN_PROGRESS, PAUSED, COMPLETED, SKIPPED
  assignedTo            String?

  // Timing
  scheduledStart        DateTime?
  scheduledDuration     Int?            // minutes
  actualStart           DateTime?
  actualEnd             DateTime?

  // Location
  workCenterName        String?

  // Notes
  notes                 String?

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  scanEvents            OperationScanEvent[]
  componentScans        ComponentScan[]

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([productionOrderId])
  @@index([department])
  @@index([status])
}

model OperationScanEvent {
  id                    String          @id @default(uuid())
  jobOperationId        String
  productionOrderId     String
  scanType              String          // START, PAUSE, RESUME, COMPLETE, SKIP
  scannedBy             String
  scannedAt             DateTime        @default(now())
  department            String

  // Device info
  deviceId              String?

  // Notes
  notes                 String?

  // Relations
  jobOperation          JobOperation    @relation(fields: [jobOperationId], references: [id], onDelete: Cascade)
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)

  @@index([jobOperationId])
  @@index([productionOrderId])
  @@index([department])
}

model ComponentScan {
  id                    String          @id @default(uuid())
  productionOrderId     String
  jobOperationId        String
  itemId                String

  // Quantities
  qtyScanned            Float
  qtyRequired           Float

  // Tracking
  scannedBy             String
  scannedAt             DateTime        @default(now())
  lotNumber             String?
  location              String?

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  jobOperation          JobOperation    @relation(fields: [jobOperationId], references: [id], onDelete: Cascade)
  item                  Item            @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([productionOrderId])
  @@index([jobOperationId])
  @@index([itemId])
}

model Notification {
  id                    String          @id @default(uuid())
  tenantId              String

  // Notification details
  type                  String          // JOB_READY, LOW_INVENTORY, QUALITY_ISSUE, DELAY
  title                 String
  message               String
  priority              String          @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT

  // Targeting
  targetDepartment      String?
  targetUserId          String?

  // Status
  isRead                Boolean         @default(false)
  readAt                DateTime?

  // Metadata
  metadata              Json?           // Additional context (jobId, itemId, etc.)

  createdAt             DateTime        @default(now())

  // Relations
  tenant                Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isRead])
  @@index([targetDepartment])
  @@index([createdAt])
}

// ============================================================
// SALES & OUTBOUND
// ============================================================

model Customer {
  id              String   @id @default(uuid())
  tenantId        String
  
  // Customer Info
  code            String   // Customer code/number
  name            String
  email           String?
  phone           String?
  
  // Billing Address
  billingAddress1 String?
  billingAddress2 String?
  billingCity     String?
  billingState    String?
  billingZip      String?
  billingCountry  String?
  
  // Shipping Address (default)
  shippingAddress1 String?
  shippingAddress2 String?
  shippingCity     String?
  shippingState    String?
  shippingZip      String?
  shippingCountry  String?
  
  // Terms & Settings
  paymentTerms    String?  // NET30, NET60, etc.
  creditLimit     Float?
  taxExempt       Boolean  @default(false)
  taxId           String?
  notes           String?
  
  // Status
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  salesOrders     SalesOrder[]
  shipments       Shipment[]
  serialNumbers   SerialNumber[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([name])
}

model SalesOrder {
  id              String           @id @default(uuid())
  tenantId        String
  siteId          String
  customerId      String
  
  // Order Info
  orderNumber     String
  customerPO      String?          // Customer's PO number
  status          SalesOrderStatus @default(DRAFT)
  
  // Dates
  orderDate       DateTime         @default(now())
  requestedDate   DateTime?        // Customer's requested delivery date
  promisedDate    DateTime?        // Our promised delivery date
  
  // Shipping
  shipToName      String?
  shipToAddress1  String?
  shipToAddress2  String?
  shipToCity      String?
  shipToState     String?
  shipToZip       String?
  shipToCountry   String?
  shippingMethod  String?          // GROUND, EXPRESS, OVERNIGHT, etc.
  
  // Financials
  subtotal        Float            @default(0)
  taxAmount       Float            @default(0)
  shippingAmount  Float            @default(0)
  discountAmount  Float            @default(0)
  total           Float            @default(0)
  currency        String           @default("USD")
  
  // Notes
  notes           String?
  internalNotes   String?
  
  // Audit
  createdByUserId String?
  approvedByUserId String?
  approvedAt      DateTime?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Restrict)
  createdBy       User?            @relation("SOCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedBy      User?            @relation("SOApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  lines           SalesOrderLine[]
  shipments       Shipment[]
  pickTasks       PickTask[]
  serialNumbers   SerialNumber[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([customerId])
  @@index([status])
  @@index([orderDate])
}

model SalesOrderLine {
  id              String       @id @default(uuid())
  salesOrderId    String
  
  // Line Info
  lineNumber      Int
  itemId          String
  description     String?
  
  // Quantities
  qtyOrdered      Float
  qtyAllocated    Float        @default(0)
  qtyPicked       Float        @default(0)
  qtyShipped      Float        @default(0)
  uom             Uom
  
  // Pricing
  unitPrice       Float
  discount        Float        @default(0)
  taxRate         Float        @default(0)
  lineTotal       Float
  
  // Status
  status          SOLineStatus @default(OPEN)
  
  // Lot/Serial (if applicable)
  lotNumber       String?
  serialNumber    String?
  
  // Notes
  notes           String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  salesOrder      SalesOrder   @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  item            Item         @relation(fields: [itemId], references: [id], onDelete: Restrict)
  shipmentLines   ShipmentLine[]
  pickTaskLines   PickTaskLine[]

  @@unique([salesOrderId, lineNumber])
  @@index([salesOrderId])
  @@index([itemId])
}

model PickTask {
  id              String       @id @default(uuid())
  tenantId        String
  siteId          String
  salesOrderId    String
  
  // Task Info
  taskNumber      String
  status          String       @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  priority        Int          @default(5)
  
  // Assignment
  assignedToUserId String?
  assignedAt      DateTime?
  
  // Completion
  startedAt       DateTime?
  completedAt     DateTime?
  completedByUserId String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  salesOrder      SalesOrder   @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  assignedTo      User?        @relation("PickTaskAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  completedBy     User?        @relation("PickTaskCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)
  lines           PickTaskLine[]

  @@unique([tenantId, taskNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([salesOrderId])
  @@index([status])
}

model PickTaskLine {
  id              String       @id @default(uuid())
  pickTaskId      String
  salesOrderLineId String
  
  // What to pick
  itemId          String
  locationId      String       // Source location
  
  // Quantities
  qtyToPick       Float
  qtyPicked       Float        @default(0)
  uom             Uom
  
  // Lot tracking
  lotNumber       String?
  
  // Status
  status          String       @default("PENDING") // PENDING, PICKED, SHORT
  
  // Actual pick info
  pickedAt        DateTime?
  pickedByUserId  String?
  actualLocationId String?     // If picked from different location
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  pickTask        PickTask     @relation(fields: [pickTaskId], references: [id], onDelete: Cascade)
  salesOrderLine  SalesOrderLine @relation(fields: [salesOrderLineId], references: [id], onDelete: Cascade)
  item            Item         @relation(fields: [itemId], references: [id], onDelete: Restrict)
  location        Location     @relation("PickFromLocation", fields: [locationId], references: [id], onDelete: Restrict)
  actualLocation  Location?    @relation("ActualPickLocation", fields: [actualLocationId], references: [id], onDelete: SetNull)
  pickedBy        User?        @relation("PickLineCompletedBy", fields: [pickedByUserId], references: [id], onDelete: SetNull)

  @@index([pickTaskId])
  @@index([salesOrderLineId])
  @@index([itemId])
}

model Shipment {
  id              String         @id @default(uuid())
  tenantId        String
  siteId          String
  salesOrderId    String
  customerId      String
  
  // Shipment Info
  shipmentNumber  String
  status          ShipmentStatus @default(DRAFT)
  
  // Carrier Info
  carrier         String?        // UPS, FedEx, USPS, etc.
  serviceLevel    String?        // Ground, Express, etc.
  trackingNumber  String?
  
  // Ship To
  shipToName      String?
  shipToAddress1  String?
  shipToAddress2  String?
  shipToCity      String?
  shipToState     String?
  shipToZip       String?
  shipToCountry   String?
  
  // Package Info
  totalPackages   Int            @default(1)
  totalWeight     Float?
  weightUnit      String         @default("LB")
  
  // Dates
  shipDate        DateTime?
  deliveryDate    DateTime?
  
  // Costs
  shippingCost    Float          @default(0)
  
  // Notes
  notes           String?
  
  // Audit
  shippedByUserId String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  salesOrder      SalesOrder     @relation(fields: [salesOrderId], references: [id], onDelete: Restrict)
  customer        Customer       @relation(fields: [customerId], references: [id], onDelete: Restrict)
  shippedBy       User?          @relation(fields: [shippedByUserId], references: [id], onDelete: SetNull)
  lines           ShipmentLine[]
  packages        ShipmentPackage[]
  serialNumbers   SerialNumber[]

  @@unique([tenantId, shipmentNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([salesOrderId])
  @@index([customerId])
  @@index([status])
}

model ShipmentLine {
  id              String       @id @default(uuid())
  shipmentId      String
  salesOrderLineId String
  
  // Line Info
  itemId          String
  qtyShipped      Float
  uom             Uom
  
  // Lot tracking
  lotNumber       String?
  serialNumber    String?
  
  createdAt       DateTime     @default(now())

  // Relations
  shipment        Shipment     @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  salesOrderLine  SalesOrderLine @relation(fields: [salesOrderLineId], references: [id], onDelete: Restrict)
  item            Item         @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([shipmentId])
  @@index([salesOrderLineId])
}

model ShipmentPackage {
  id              String       @id @default(uuid())
  shipmentId      String
  
  // Package Info
  packageNumber   Int
  trackingNumber  String?
  
  // Dimensions
  length          Float?
  width           Float?
  height          Float?
  dimensionUnit   String       @default("IN")
  weight          Float?
  weightUnit      String       @default("LB")
  
  // Contents description
  contents        String?
  
  createdAt       DateTime     @default(now())

  // Relations
  shipment        Shipment     @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@unique([shipmentId, packageNumber])
  @@index([shipmentId])
}

// ============================================================
// LOT/SERIAL TRACKING & QUALITY MANAGEMENT (Phase 4)
// ============================================================

// Lot master - tracking production lots
model Lot {
  id               String   @id @default(uuid())
  tenantId         String
  itemId           String
  lotNumber        String   // Unique lot identifier

  // Quantities
  qtyProduced      Float
  qtyAvailable     Float    // Current available quantity
  qtyAllocated     Float    @default(0)
  qtyConsumed      Float    @default(0)
  uom              Uom

  // Dates
  productionDate   DateTime
  expirationDate   DateTime?
  receiptDate      DateTime?

  // Source
  supplierId       String?  // If from external supplier
  productionOrderId String? // If internally produced

  // Status
  status           String   @default("AVAILABLE") // AVAILABLE, QUARANTINE, HOLD, CONSUMED, EXPIRED
  holdReasonId     String?

  // Quality
  qcStatus         String?  @default("PENDING") // PENDING, PASSED, FAILED, CONDITIONAL
  qcDate           DateTime?
  qcNotes          String?

  // Metadata
  batchNumber      String?
  supplierLotNumber String?
  notes            String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item             Item     @relation("LotItem", fields: [itemId], references: [id], onDelete: Restrict)
  supplier         Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  productionOrder  ProductionOrder? @relation("LotProductionOrder", fields: [productionOrderId], references: [id], onDelete: SetNull)
  holdReason       ReasonCode? @relation("LotHoldReason", fields: [holdReasonId], references: [id], onDelete: SetNull)
  serialNumbers    SerialNumber[]
  inspections      QualityInspection[]
  lotHistory       LotHistory[]

  @@unique([tenantId, itemId, lotNumber])
  @@index([tenantId])
  @@index([itemId])
  @@index([lotNumber])
  @@index([status])
  @@index([expirationDate])
}

// Serial number tracking for serialized items
model SerialNumber {
  id               String   @id @default(uuid())
  tenantId         String
  itemId           String
  lotId            String?
  serialNumber     String   // Unique serial identifier

  // Status
  status           String   @default("AVAILABLE") // AVAILABLE, ALLOCATED, SHIPPED, CONSUMED, WARRANTY_RETURN, SCRAPPED

  // Lifecycle
  manufacturedDate DateTime?
  receivedDate     DateTime?
  shippedDate      DateTime?
  warrantyExpiry   DateTime?

  // Location
  currentLocationId String?

  // Ownership
  customerId       String?  // If shipped to customer
  salesOrderId     String?
  shipmentId       String?

  // Quality
  qcStatus         String?  // PENDING, PASSED, FAILED

  // Metadata
  notes            String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item             Item      @relation("SerialItem", fields: [itemId], references: [id], onDelete: Restrict)
  lot              Lot?      @relation(fields: [lotId], references: [id], onDelete: SetNull)
  location         Location? @relation("SerialLocation", fields: [currentLocationId], references: [id], onDelete: SetNull)
  customer         Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  salesOrder       SalesOrder? @relation(fields: [salesOrderId], references: [id], onDelete: SetNull)
  shipment         Shipment? @relation(fields: [shipmentId], references: [id], onDelete: SetNull)
  history          SerialNumberHistory[]

  @@unique([tenantId, itemId, serialNumber])
  @@index([tenantId])
  @@index([itemId])
  @@index([lotId])
  @@index([serialNumber])
  @@index([status])
}

// Lot history tracking
model LotHistory {
  id               String   @id @default(uuid())
  lotId            String
  eventType        String   // CREATED, RECEIVED, QC_PASSED, QC_FAILED, HOLD, RELEASE, CONSUMED, EXPIRED
  qtyBefore        Float
  qtyAfter         Float
  qtyChanged       Float
  notes            String?
  userId           String?
  createdAt        DateTime @default(now())

  // Relations
  lot              Lot      @relation(fields: [lotId], references: [id], onDelete: Cascade)

  @@index([lotId])
  @@index([createdAt])
}

// Serial number history tracking
model SerialNumberHistory {
  id               String   @id @default(uuid())
  serialNumberId   String
  eventType        String   // RECEIVED, ALLOCATED, SHIPPED, QC_TESTED, LOCATION_MOVED, STATUS_CHANGED
  statusBefore     String?
  statusAfter      String?
  locationBefore   String?
  locationAfter    String?
  notes            String?
  userId           String?
  createdAt        DateTime @default(now())

  // Relations
  serialNumber     SerialNumber @relation(fields: [serialNumberId], references: [id], onDelete: Cascade)

  @@index([serialNumberId])
  @@index([createdAt])
}

// Quality inspections
model QualityInspection {
  id               String   @id @default(uuid())
  tenantId         String
  inspectionNumber String

  // What's being inspected
  inspectionType   String   // RECEIVING, IN_PROCESS, FINAL, AUDIT
  itemId           String?
  lotId            String?
  productionOrderId String?
  purchaseOrderId  String?

  // Inspection plan
  planId           String?

  // Results
  status           String   @default("PENDING") // PENDING, IN_PROGRESS, PASSED, FAILED, CONDITIONAL
  overallResult    String?  // ACCEPT, REJECT, CONDITIONAL_ACCEPT

  // Quantities
  sampleSize       Int?
  qtyPassed        Float?
  qtyFailed        Float?

  // People
  inspectorId      String?
  reviewerId       String?

  // Dates
  scheduledDate    DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  reviewedAt       DateTime?

  // Notes
  notes            String?
  internalNotes    String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item             Item?    @relation("InspectionItem", fields: [itemId], references: [id], onDelete: SetNull)
  lot              Lot?     @relation(fields: [lotId], references: [id], onDelete: SetNull)
  productionOrder  ProductionOrder? @relation("InspectionProductionOrder", fields: [productionOrderId], references: [id], onDelete: SetNull)
  purchaseOrder    PurchaseOrder? @relation("InspectionPurchaseOrder", fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  plan             QualityInspectionPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)
  checkpoints      QualityCheckpoint[]
  ncrs             NonConformanceReport[] @relation("NCRInspection")

  @@unique([tenantId, inspectionNumber])
  @@index([tenantId])
  @@index([itemId])
  @@index([lotId])
  @@index([status])
  @@index([inspectionType])
}

// Quality inspection plan template
model QualityInspectionPlan {
  id               String   @id @default(uuid())
  tenantId         String
  name             String
  description      String?
  inspectionType   String   // RECEIVING, IN_PROCESS, FINAL, AUDIT

  // Applicability
  itemId           String?  // Specific to an item or generic
  category         ItemCategory?

  // Sampling
  sampleSizeType   String   @default("FIXED") // FIXED, PERCENTAGE, AQL
  sampleSize       Int?
  samplePercentage Float?

  // Status
  isActive         Boolean  @default(true)
  version          Int      @default(1)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item             Item?    @relation("InspectionPlanItem", fields: [itemId], references: [id], onDelete: SetNull)
  checkpointTemplates QualityCheckpointTemplate[]
  inspections      QualityInspection[]

  @@index([tenantId])
  @@index([itemId])
  @@index([isActive])
}

// Checkpoint template for inspection plans
model QualityCheckpointTemplate {
  id               String   @id @default(uuid())
  planId           String
  sequence         Int
  checkpointName   String
  description      String?
  measurementType  String   // PASS_FAIL, NUMERIC, VISUAL, DIMENSION

  // For numeric measurements
  targetValue      Float?
  upperLimit       Float?
  lowerLimit       Float?
  unit             String?

  // Criticality
  isCritical       Boolean  @default(false)

  // Instructions
  instructions     String?

  // Relations
  plan             QualityInspectionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, sequence])
  @@index([planId])
}

// Actual inspection checkpoints (filled during inspection)
model QualityCheckpoint {
  id               String   @id @default(uuid())
  inspectionId     String
  sequence         Int
  checkpointName   String
  description      String?
  measurementType  String

  // Result
  result           String?  // PASS, FAIL, N/A
  measuredValue    Float?
  notes            String?

  // Reference values
  targetValue      Float?
  upperLimit       Float?
  lowerLimit       Float?
  unit             String?

  // Criticality
  isCritical       Boolean  @default(false)

  checkedAt        DateTime?
  checkedBy        String?

  // Relations
  inspection       QualityInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@unique([inspectionId, sequence])
  @@index([inspectionId])
}

// Non-conformance reports (NCR)
model NonConformanceReport {
  id               String   @id @default(uuid())
  tenantId         String
  ncrNumber        String

  // What's non-conforming
  itemId           String?
  lotId            String?
  inspectionId     String?
  productionOrderId String?

  // Issue details
  issueType        String   // DIMENSIONAL, COSMETIC, FUNCTIONAL, MATERIAL, DOCUMENTATION
  severity         String   // MINOR, MAJOR, CRITICAL
  description      String
  rootCause        String?

  // Quantities
  qtyAffected      Float
  uom              Uom

  // Disposition
  disposition      String   @default("PENDING") // PENDING, USE_AS_IS, REWORK, SCRAP, RETURN_TO_SUPPLIER
  dispositionNotes String?
  dispositionDate  DateTime?

  // Status
  status           String   @default("OPEN") // OPEN, IN_REVIEW, RESOLVED, CLOSED

  // People
  reportedBy       String?
  reviewedBy       String?
  approvedBy       String?

  // Dates
  reportedAt       DateTime @default(now())
  reviewedAt       DateTime?
  closedAt         DateTime?

  // CAPA link
  capaRequired     Boolean  @default(false)

  // Attachments
  attachments      Json?    // Array of file URLs

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item             Item?    @relation("NCRItem", fields: [itemId], references: [id], onDelete: SetNull)
  inspection       QualityInspection? @relation("NCRInspection", fields: [inspectionId], references: [id], onDelete: SetNull)
  productionOrder  ProductionOrder? @relation("NCRProductionOrder", fields: [productionOrderId], references: [id], onDelete: SetNull)
  capas            CAPA[]

  @@unique([tenantId, ncrNumber])
  @@index([tenantId])
  @@index([itemId])
  @@index([status])
  @@index([severity])
}

// Corrective and Preventive Actions (CAPA)
model CAPA {
  id               String   @id @default(uuid())
  tenantId         String
  capaNumber       String

  // Type
  type             String   // CORRECTIVE, PREVENTIVE

  // Source
  sourceType       String   // NCR, AUDIT, CUSTOMER_COMPLAINT, INTERNAL_REVIEW
  ncrId            String?

  // Issue
  problemStatement String
  rootCauseAnalysis String?

  // Action plan
  proposedActions  String
  responsiblePerson String?
  targetDate       DateTime?

  // Implementation
  implementationPlan String?
  implementedAt    DateTime?

  // Verification
  verificationMethod String?
  verifiedAt       DateTime?
  verifiedBy       String?
  verificationNotes String?

  // Status
  status           String   @default("OPEN") // OPEN, IN_PROGRESS, IMPLEMENTED, VERIFIED, CLOSED

  // Effectiveness
  effectivenessCheck String?
  effectivenessDate DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ncr              NonConformanceReport? @relation(fields: [ncrId], references: [id], onDelete: SetNull)

  @@unique([tenantId, capaNumber])
  @@index([tenantId])
  @@index([ncrId])
  @@index([status])
  @@index([type])
}

// ============================================================
// CUSTOM WORKFLOW & DEPARTMENTS (Phase 3)
// ============================================================

// Custom configurable departments per tenant
model CustomDepartment {
  id               String   @id @default(uuid())
  tenantId         String
  name             String   // Display name: "Welding", "Painting", etc.
  code             String   // Internal code: "WELDING", "PAINTING"
  color            String   @default("#3b82f6") // Hex color for UI
  icon             String?  // Icon name or emoji
  allowConcurrent  Boolean  @default(true) // Allow multiple jobs at once
  requireQC        Boolean  @default(false) // Require QC after this step
  defaultDuration  Int?     // Default duration in minutes
  order            Int      // Display order in UI
  isActive         Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  routingSteps     RoutingStep[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

// Production routing - defines the path a product takes
model ProductionRouting {
  id               String   @id @default(uuid())
  tenantId         String
  itemId           String?  // Optional: specific to a product
  name             String   // "Standard Filter Assembly"
  description      String?
  isDefault        Boolean  @default(false) // Default routing for items without specific routing
  isActive         Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item             Item?           @relation(fields: [itemId], references: [id], onDelete: Cascade)
  steps            RoutingStep[]
  jobs             Job[]           // Jobs using this routing

  @@index([tenantId])
  @@index([itemId])
  @@index([tenantId, isDefault])
}

// Individual step in a routing
model RoutingStep {
  id               String   @id @default(uuid())
  routingId        String
  departmentId     String
  sequence         Int      // Order of operations
  required         Boolean  @default(true)
  canSkip          Boolean  @default(false)
  estimatedMinutes Int?     // Estimated time for this step

  // Relations
  routing          ProductionRouting @relation(fields: [routingId], references: [id], onDelete: Cascade)
  department       CustomDepartment  @relation(fields: [departmentId], references: [id], onDelete: Restrict)

  @@unique([routingId, sequence])
  @@index([routingId])
  @@index([departmentId])
}

// Workflow automation rules
model WorkflowRule {
  id               String   @id @default(uuid())
  tenantId         String
  name             String
  description      String?
  triggerType      String   // ITEM_CREATED, STOCK_BELOW_THRESHOLD, ORDER_COMPLETED, etc.
  conditions       Json     // Array of condition objects
  actions          Json     // Array of action objects
  isActive         Boolean  @default(true)
  priority         Int      @default(5)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  executions       WorkflowExecution[]

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([triggerType])
}

// Track workflow executions
model WorkflowExecution {
  id               String   @id @default(uuid())
  workflowRuleId   String
  triggerData      Json     // Data that triggered the workflow
  status           String   // PENDING, SUCCESS, FAILED
  result           Json?    // Execution result
  errorMessage     String?
  executedAt       DateTime @default(now())

  // Relations
  workflowRule     WorkflowRule @relation(fields: [workflowRuleId], references: [id], onDelete: Cascade)

  @@index([workflowRuleId])
  @@index([status])
  @@index([executedAt])
}
