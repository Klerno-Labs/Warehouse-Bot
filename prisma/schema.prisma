generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  Admin
  Supervisor
  Inventory
  Operator
  Sales
  Purchasing
  Maintenance
  QC
  Viewer
}

enum Uom {
  EA
  FT
  YD
  ROLL
}

enum ItemCategory {
  PRODUCTION
  PACKAGING
  FACILITY
  CHEMICAL_MRO
}

enum LocationType {
  RECEIVING
  STOCK
  WIP
  QC_HOLD
  SHIPPING
}

enum ReasonType {
  SCRAP
  ADJUST
  HOLD
}

enum InventoryEventType {
  RECEIVE
  MOVE
  ISSUE_TO_WORKCELL
  RETURN
  SCRAP
  HOLD
  RELEASE
  COUNT
  ADJUST
}

enum CycleCountStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CycleCountType {
  FULL
  ABC
  RANDOM
  LOCATION
  ITEM
}

enum CountLineStatus {
  PENDING
  COUNTED
  VARIANCE_APPROVED
  VARIANCE_REJECTED
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum POLineStatus {
  PENDING
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum BOMStatus {
  DRAFT
  ACTIVE
  INACTIVE
  SUPERSEDED
}

enum ProductionOrderStatus {
  PLANNED
  RELEASED
  IN_PROGRESS
  COMPLETED
  CLOSED
  CANCELLED
}

enum ComponentIssueMethod {
  MANUAL
  BACKFLUSH
  PREISSUE
}

// ============================================================
// MULTI-TENANT & ORGANIZATIONAL STRUCTURE
// ============================================================

model Tenant {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  enabledModules  String[]
  defaultCurrency String   @default("USD") // ISO 4217 currency code
  locale          String   @default("en-US") // Locale for formatting
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  sites             Site[]
  users             User[]
  departments       Department[]
  workcells         Workcell[]
  devices           Device[]
  badges            Badge[]
  auditEvents       AuditEvent[]
  items             Item[]
  locations         Location[]
  reasonCodes       ReasonCode[]
  inventoryEvents   InventoryEvent[]
  inventoryBalances InventoryBalance[]
  cycleCounts       CycleCount[]
  cycleCountLines   CycleCountLine[]
  jobs              Job[]
  suppliers         Supplier[]
  purchaseOrders    PurchaseOrder[]
  receipts          Receipt[]
  billsOfMaterial   BillOfMaterial[]
  productionOrders  ProductionOrder[]
  notifications     Notification[]
}

model Site {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departments       Department[]
  workcells         Workcell[]
  devices           Device[]
  locations         Location[]
  inventoryEvents   InventoryEvent[]
  inventoryBalances InventoryBalance[]
  cycleCounts       CycleCount[]
  cycleCountLines   CycleCountLine[]
  jobs              Job[]
  purchaseOrders    PurchaseOrder[]
  receipts          Receipt[]
  productionOrders  ProductionOrder[]

  @@index([tenantId])
}

model Department {
  id        String   @id @default(uuid())
  tenantId  String
  siteId    String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site      Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  workcells Workcell[]

  @@index([tenantId])
  @@index([siteId])
}

model Workcell {
  id           String   @id @default(uuid())
  tenantId     String
  siteId       String
  departmentId String?
  name         String
  description  String?
  status       String   @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department      Department?      @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  devices         Device[]
  inventoryEvents InventoryEvent[]
  jobs            Job[]
  productionOrders ProductionOrder[]

  @@index([tenantId])
  @@index([siteId])
  @@index([departmentId])
}

model Device {
  id           String   @id @default(uuid())
  tenantId     String
  siteId       String
  workcellId   String?
  name         String
  type         String
  serialNumber String?
  status       String   @default("online")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  workcell        Workcell?        @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  inventoryEvents InventoryEvent[]

  @@index([tenantId])
  @@index([siteId])
  @@index([workcellId])
}

// ============================================================
// USERS & AUTHENTICATION
// ============================================================

model User {
  id        String   @id @default(uuid())
  tenantId  String
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(Viewer)
  siteIds   String[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant                  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  badges                  Badge[]
  auditEvents             AuditEvent[]
  inventoryEvents         InventoryEvent[]
  cycleCountsCreated      CycleCount[]     @relation("CycleCountCreatedBy")
  cycleCountsAssigned     CycleCount[]     @relation("CycleCountAssignedTo")
  cycleCountLinesCounted  CycleCountLine[] @relation("CountedBy")
  cycleCountLinesApproved CycleCountLine[] @relation("ApprovedBy")
  jobsAssigned            Job[]            @relation("AssignedJobs")
  jobsCreated             Job[]            @relation("CreatedJobs")
  jobLinesCompleted       JobLine[]        @relation("JobLineCompletedBy")
  purchaseOrdersCreated   PurchaseOrder[]  @relation("POCreatedBy")
  purchaseOrdersApproved  PurchaseOrder[]  @relation("POApprovedBy")
  bomsCreated             BillOfMaterial[] @relation("BOMCreatedBy")
  bomsApproved            BillOfMaterial[] @relation("BOMApprovedBy")
  productionOrdersCreated ProductionOrder[] @relation("ProductionOrderCreatedBy")
  productionOrdersReleased ProductionOrder[] @relation("ProductionOrderReleasedBy")
  consumptionsCreated     ProductionConsumption[] @relation("ConsumptionCreatedBy")
  outputsCreated          ProductionOutput[] @relation("OutputCreatedBy")

  @@index([tenantId])
  @@index([email])
}

model Badge {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String
  badgeNumber String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, badgeNumber])
  @@index([tenantId])
  @@index([userId])
}

// ============================================================
// AUDIT TRAIL
// ============================================================

model AuditEvent {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String
  entityType String
  entityId   String?
  details    String?
  ipAddress  String?
  timestamp  DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([timestamp])
  @@index([entityType, entityId])
}

// ============================================================
// INVENTORY MODULE
// ============================================================

model Item {
  id               String       @id @default(uuid())
  tenantId         String
  sku              String
  name             String
  description      String?
  category         ItemCategory
  baseUom          Uom
  allowedUoms      Json // Array of {uom: Uom, toBase: number}
  minQtyBase       Float?
  maxQtyBase       Float?
  reorderPointBase Float?
  leadTimeDays     Int?

  // Cost tracking fields
  costBase         Float?       // Standard cost per base UOM
  avgCostBase      Float?       // Weighted average cost (auto-calculated)
  lastCostBase     Float?       // Most recent purchase cost

  // Barcode fields
  barcode          String?      // Primary barcode
  barcodeType      String?      // EAN-13, UPC-A, CODE-128, etc
  alternateBarcode String?      // Secondary barcode

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventoryEvents   InventoryEvent[]
  balances          InventoryBalance[]
  cycleCountLines   CycleCountLine[]
  jobLines          JobLine[]
  purchaseOrderLines PurchaseOrderLine[]
  receiptLines      ReceiptLine[]
  boms              BillOfMaterial[]    @relation("BOMFinishedGood")
  bomComponents     BOMComponent[]      @relation("BOMComponentItem")
  productionOrders  ProductionOrder[]   @relation("ProductionOrderItem")
  consumptions      ProductionConsumption[] @relation("ConsumptionItem")
  outputs           ProductionOutput[]  @relation("OutputItem")
  componentScans    ComponentScan[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([name])
}

model Location {
  id        String        @id @default(uuid())
  tenantId  String
  siteId    String
  zone      String?
  bin       String?
  label     String
  type      LocationType?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site            Site               @relation(fields: [siteId], references: [id], onDelete: Cascade)
  fromEvents      InventoryEvent[]   @relation("FromLocation")
  toEvents        InventoryEvent[]   @relation("ToLocation")
  balances        InventoryBalance[]
  cycleCountLines CycleCountLine[]
  jobLinesFrom    JobLine[]          @relation("JobLineFromLocation")
  jobLinesTo      JobLine[]          @relation("JobLineToLocation")
  receipts        Receipt[]
  consumptions    ProductionConsumption[] @relation("ConsumptionLocation")
  outputs         ProductionOutput[] @relation("OutputLocation")

  @@unique([tenantId, siteId, label])
  @@index([tenantId])
  @@index([siteId])
}

model ReasonCode {
  id          String     @id @default(uuid())
  tenantId    String
  type        ReasonType
  code        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inventoryEvents InventoryEvent[]
  consumptions    ProductionConsumption[]

  @@unique([tenantId, type, code])
  @@index([tenantId])
}

model InventoryEvent {
  id              String             @id @default(uuid())
  tenantId        String
  siteId          String
  eventType       InventoryEventType
  itemId          String
  qtyEntered      Float
  uomEntered      Uom
  qtyBase         Float
  fromLocationId  String?
  toLocationId    String?
  workcellId      String?
  referenceId     String?
  reasonCodeId    String?
  notes           String?
  createdByUserId String?
  deviceId        String?
  createdAt       DateTime           @default(now())

  // Relations
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site         Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  item         Item        @relation(fields: [itemId], references: [id], onDelete: Restrict)
  fromLocation Location?   @relation("FromLocation", fields: [fromLocationId], references: [id], onDelete: Restrict)
  toLocation   Location?   @relation("ToLocation", fields: [toLocationId], references: [id], onDelete: Restrict)
  workcell     Workcell?   @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  reasonCode   ReasonCode? @relation(fields: [reasonCodeId], references: [id], onDelete: SetNull)
  createdBy    User?       @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  device       Device?     @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([siteId])
  @@index([itemId])
  @@index([createdAt])
  @@index([eventType])                       // For filtering by event type
  @@index([tenantId, createdAt(sort: Desc)]) // For dashboard queries
  @@index([itemId, eventType])               // For inventory aging queries
}

model InventoryBalance {
  id         String   @id @default(uuid())
  tenantId   String
  siteId     String
  itemId     String
  locationId String
  qtyBase    Float
  updatedAt  DateTime @updatedAt

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site     Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([tenantId, itemId, locationId])
  @@index([tenantId])
  @@index([siteId])
  @@index([itemId])
  @@index([locationId])
}

// ============================================================
// CYCLE COUNTS MODULE
// ============================================================

model CycleCount {
  id               String           @id @default(uuid())
  tenantId         String
  siteId           String
  name             String
  type             CycleCountType
  status           CycleCountStatus @default(SCHEDULED)
  scheduledDate    DateTime
  startedAt        DateTime?
  completedAt      DateTime?
  assignedToUserId String?
  notes            String?
  createdByUserId  String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  tenant     Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  createdBy  User             @relation("CycleCountCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  assignedTo User?            @relation("CycleCountAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  lines      CycleCountLine[]

  @@index([tenantId])
  @@index([siteId])
  @@index([status])
  @@index([scheduledDate])
}

model CycleCountLine {
  id               String          @id @default(uuid())
  cycleCountId     String
  tenantId         String
  siteId           String
  itemId           String
  locationId       String
  expectedQtyBase  Float
  countedQtyBase   Float?
  varianceQtyBase  Float?
  status           CountLineStatus @default(PENDING)
  countedByUserId  String?
  countedAt        DateTime?
  approvedByUserId String?
  approvedAt       DateTime?
  notes            String?

  // Relations
  cycleCount CycleCount @relation(fields: [cycleCountId], references: [id], onDelete: Cascade)
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  item       Item       @relation(fields: [itemId], references: [id], onDelete: Restrict)
  location   Location   @relation(fields: [locationId], references: [id], onDelete: Restrict)
  countedBy  User?      @relation("CountedBy", fields: [countedByUserId], references: [id], onDelete: SetNull)
  approvedBy User?      @relation("ApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)

  @@index([cycleCountId])
  @@index([tenantId])
  @@index([siteId])
  @@index([itemId])
  @@index([locationId])
  @@index([status])
}

// ============================================================
// JOBS MODULE (Placeholder for future implementation)
// ============================================================

model Job {
  id               String    @id @default(uuid())
  tenantId         String
  siteId           String
  workcellId       String?
  jobNumber        String
  description      String?
  type             String?
  status           String    @default("PENDING")
  assignedToUserId String?
  createdByUserId  String?
  scheduledDate    DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)
  workcell   Workcell? @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  assignedTo User?     @relation("AssignedJobs", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  createdBy  User?     @relation("CreatedJobs", fields: [createdByUserId], references: [id], onDelete: SetNull)
  lines      JobLine[]

  @@unique([tenantId, jobNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([status])
  @@index([assignedToUserId])
}

model JobLine {
  id                String    @id @default(uuid())
  jobId             String
  itemId            String
  qtyOrdered        Float
  qtyCompleted      Float     @default(0)
  qtyBase           Float
  fromLocationId    String?
  toLocationId      String?
  status            String    @default("PENDING")
  notes             String?
  completedByUserId String?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  job          Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  item         Item      @relation(fields: [itemId], references: [id], onDelete: Restrict)
  fromLocation Location? @relation("JobLineFromLocation", fields: [fromLocationId], references: [id], onDelete: SetNull)
  toLocation   Location? @relation("JobLineToLocation", fields: [toLocationId], references: [id], onDelete: SetNull)
  completedBy  User?     @relation("JobLineCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([itemId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@index([completedByUserId])
}

// ============================================================
// PURCHASING MODULE
// ============================================================

model Supplier {
  id              String   @id @default(uuid())
  tenantId        String
  code            String
  name            String
  contactName     String?
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  paymentTerms    String?
  leadTimeDays    Int?
  isActive        Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([name])
}

model PurchaseOrder {
  id               String              @id @default(uuid())
  tenantId         String
  siteId           String
  supplierId       String
  poNumber         String
  status           PurchaseOrderStatus @default(DRAFT)
  orderDate        DateTime
  expectedDelivery DateTime?
  notes            String?
  subtotal         Float               @default(0)
  tax              Float               @default(0)
  shipping         Float               @default(0)
  total            Float               @default(0)
  createdByUserId  String?
  approvedByUserId String?
  approvedAt       DateTime?
  sentAt           DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Relations
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site       Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)
  supplier   Supplier          @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  createdBy  User?             @relation("POCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedBy User?             @relation("POApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  lines      PurchaseOrderLine[]
  receipts   Receipt[]

  @@unique([tenantId, poNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
}

model PurchaseOrderLine {
  id               String        @id @default(uuid())
  purchaseOrderId  String
  itemId           String
  lineNumber       Int
  description      String?
  qtyOrdered       Float
  qtyReceived      Float         @default(0)
  uom              Uom
  unitPrice        Float
  lineTotal        Float
  status           POLineStatus  @default(PENDING)
  expectedDelivery DateTime?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  purchaseOrder PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item            @relation(fields: [itemId], references: [id], onDelete: Restrict)
  receiptLines  ReceiptLine[]

  @@index([purchaseOrderId])
  @@index([itemId])
  @@index([status])
}

model Receipt {
  id              String    @id @default(uuid())
  tenantId        String
  siteId          String
  purchaseOrderId String
  receiptNumber   String
  receiptDate     DateTime
  receivedBy      String?
  locationId      String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tenant        Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site          Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)
  purchaseOrder PurchaseOrder     @relation(fields: [purchaseOrderId], references: [id], onDelete: Restrict)
  location      Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  lines         ReceiptLine[]

  @@unique([tenantId, receiptNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([purchaseOrderId])
  @@index([receiptDate])
}

model ReceiptLine {
  id                  String    @id @default(uuid())
  receiptId           String
  purchaseOrderLineId String
  itemId              String
  qtyReceived         Float
  uom                 Uom
  notes               String?
  createdAt           DateTime  @default(now())

  // Relations
  receipt           Receipt           @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  purchaseOrderLine PurchaseOrderLine @relation(fields: [purchaseOrderLineId], references: [id], onDelete: Restrict)
  item              Item              @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([receiptId])
  @@index([purchaseOrderLineId])
  @@index([itemId])
}

// ============================================================
// MANUFACTURING & BILL OF MATERIALS
// ============================================================

model BillOfMaterial {
  id              String      @id @default(uuid())
  tenantId        String
  itemId          String
  bomNumber       String
  version         Int         @default(1)
  description     String?
  status          BOMStatus   @default(DRAFT)

  // Quantities
  baseQty         Float       @default(1)
  baseUom         Uom         @default(EA)

  // Effectivity
  effectiveFrom   DateTime    @default(now())
  effectiveTo     DateTime?

  // Metadata
  notes           String?
  createdByUserId String?
  approvedByUserId String?
  approvedAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  tenant          Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item            Item                 @relation("BOMFinishedGood", fields: [itemId], references: [id], onDelete: Restrict)
  createdBy       User?                @relation("BOMCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedBy      User?                @relation("BOMApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  components      BOMComponent[]
  productionOrders ProductionOrder[]

  @@unique([tenantId, bomNumber, version])
  @@index([tenantId])
  @@index([itemId])
  @@index([status])
}

model BOMComponent {
  id              String      @id @default(uuid())
  bomId           String
  itemId          String
  sequence        Int

  // Quantities
  qtyPer          Float
  uom             Uom
  scrapFactor     Float       @default(0)

  // Planning
  isOptional      Boolean     @default(false)
  isPurchased     Boolean     @default(false)
  leadTimeOffset  Int?        @default(0)

  // Issue method
  issueMethod     ComponentIssueMethod @default(BACKFLUSH)

  // Metadata
  notes           String?
  referenceDesignator String?

  // Relations
  bom             BillOfMaterial @relation(fields: [bomId], references: [id], onDelete: Cascade)
  item            Item           @relation("BOMComponentItem", fields: [itemId], references: [id], onDelete: Restrict)
  consumptions    ProductionConsumption[]

  @@index([bomId])
  @@index([itemId])
  @@unique([bomId, sequence])
}

model ProductionOrder {
  id                String                @id @default(uuid())
  tenantId          String
  siteId            String
  bomId             String
  orderNumber       String
  status            ProductionOrderStatus @default(PLANNED)

  // What to produce
  itemId            String
  qtyOrdered        Float
  qtyCompleted      Float                 @default(0)
  qtyRejected       Float                 @default(0)
  uom               Uom

  // When
  scheduledStart    DateTime
  scheduledEnd      DateTime?
  actualStart       DateTime?
  actualEnd         DateTime?

  // Where
  workcellId        String?

  // Lot/Batch tracking
  lotNumber         String?
  batchNumber       String?

  // Metadata
  priority          Int                   @default(5)
  notes             String?
  createdByUserId   String?
  releasedByUserId  String?
  releasedAt        DateTime?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  // Relations
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site              Site                  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  bom               BillOfMaterial        @relation(fields: [bomId], references: [id], onDelete: Restrict)
  item              Item                  @relation("ProductionOrderItem", fields: [itemId], references: [id], onDelete: Restrict)
  workcell          Workcell?             @relation(fields: [workcellId], references: [id], onDelete: SetNull)
  createdBy         User?                 @relation("ProductionOrderCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  releasedBy        User?                 @relation("ProductionOrderReleasedBy", fields: [releasedByUserId], references: [id], onDelete: SetNull)
  consumptions      ProductionConsumption[]
  outputs           ProductionOutput[]
  jobOperations     JobOperation[]
  scanEvents        OperationScanEvent[]
  componentScans    ComponentScan[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([siteId])
  @@index([bomId])
  @@index([itemId])
  @@index([status])
  @@index([scheduledStart])
}

model ProductionConsumption {
  id                    String          @id @default(uuid())
  productionOrderId     String
  bomComponentId        String?
  itemId                String

  // Quantities
  qtyConsumed           Float
  uom                   Uom
  qtyBase               Float

  // Source
  fromLocationId        String
  lotNumber             String?
  serialNumber          String?

  // Tracking
  isBackflushed         Boolean         @default(false)
  isScrap               Boolean         @default(false)
  reasonCodeId          String?

  // Reference
  referenceId           String?
  notes                 String?
  createdByUserId       String?
  createdAt             DateTime        @default(now())

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  bomComponent          BOMComponent?   @relation(fields: [bomComponentId], references: [id], onDelete: SetNull)
  item                  Item            @relation("ConsumptionItem", fields: [itemId], references: [id], onDelete: Restrict)
  fromLocation          Location        @relation("ConsumptionLocation", fields: [fromLocationId], references: [id], onDelete: Restrict)
  reasonCode            ReasonCode?     @relation(fields: [reasonCodeId], references: [id], onDelete: SetNull)
  createdBy             User?           @relation("ConsumptionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([productionOrderId])
  @@index([itemId])
  @@index([fromLocationId])
}

model ProductionOutput {
  id                    String          @id @default(uuid())
  productionOrderId     String
  itemId                String

  // Quantities
  qtyProduced           Float
  qtyRejected           Float           @default(0)
  uom                   Uom
  qtyBase               Float

  // Destination
  toLocationId          String
  lotNumber             String?
  batchNumber           String?
  expirationDate        DateTime?

  // Quality
  inspectionStatus      String?

  // Reference
  referenceId           String?
  notes                 String?
  createdByUserId       String?
  createdAt             DateTime        @default(now())

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  item                  Item            @relation("OutputItem", fields: [itemId], references: [id], onDelete: Restrict)
  toLocation            Location        @relation("OutputLocation", fields: [toLocationId], references: [id], onDelete: Restrict)
  createdBy             User?           @relation("OutputCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([productionOrderId])
  @@index([itemId])
  @@index([toLocationId])
}
// Job Tracking Models

model JobOperation {
  id                    String          @id @default(uuid())
  productionOrderId     String
  sequence              Int
  department            String
  operationName         String
  description           String?
  status                String          @default("PENDING") // PENDING, IN_PROGRESS, PAUSED, COMPLETED, SKIPPED
  assignedTo            String?

  // Timing
  scheduledStart        DateTime?
  scheduledDuration     Int?            // minutes
  actualStart           DateTime?
  actualEnd             DateTime?

  // Location
  workCenterName        String?

  // Notes
  notes                 String?

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  scanEvents            OperationScanEvent[]
  componentScans        ComponentScan[]

  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([productionOrderId])
  @@index([department])
  @@index([status])
}

model OperationScanEvent {
  id                    String          @id @default(uuid())
  jobOperationId        String
  productionOrderId     String
  scanType              String          // START, PAUSE, RESUME, COMPLETE, SKIP
  scannedBy             String
  scannedAt             DateTime        @default(now())
  department            String

  // Device info
  deviceId              String?

  // Notes
  notes                 String?

  // Relations
  jobOperation          JobOperation    @relation(fields: [jobOperationId], references: [id], onDelete: Cascade)
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)

  @@index([jobOperationId])
  @@index([productionOrderId])
  @@index([department])
}

model ComponentScan {
  id                    String          @id @default(uuid())
  productionOrderId     String
  jobOperationId        String
  itemId                String

  // Quantities
  qtyScanned            Float
  qtyRequired           Float

  // Tracking
  scannedBy             String
  scannedAt             DateTime        @default(now())
  lotNumber             String?
  location              String?

  // Relations
  productionOrder       ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  jobOperation          JobOperation    @relation(fields: [jobOperationId], references: [id], onDelete: Cascade)
  item                  Item            @relation(fields: [itemId], references: [id], onDelete: Restrict)

  @@index([productionOrderId])
  @@index([jobOperationId])
  @@index([itemId])
}

model Notification {
  id                    String          @id @default(uuid())
  tenantId              String

  // Notification details
  type                  String          // JOB_READY, LOW_INVENTORY, QUALITY_ISSUE, DELAY
  title                 String
  message               String
  priority              String          @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT

  // Targeting
  targetDepartment      String?
  targetUserId          String?

  // Status
  isRead                Boolean         @default(false)
  readAt                DateTime?

  // Metadata
  metadata              Json?           // Additional context (jobId, itemId, etc.)

  createdAt             DateTime        @default(now())

  // Relations
  tenant                Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isRead])
  @@index([targetDepartment])
  @@index([createdAt])
}
