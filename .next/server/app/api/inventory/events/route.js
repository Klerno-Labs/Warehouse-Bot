"use strict";(()=>{var e={};e.id=420,e.ids=[420],e.modules={7096:e=>{e.exports=require("bcrypt")},2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},7987:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>w,patchFetch:()=>g,requestAsyncStorage:()=>L,routeModule:()=>v,serverHooks:()=>E,staticGenerationAsyncStorage:()=>R});var r={};n.r(r),n.d(r,{GET:()=>f,POST:()=>y});var o=n(9303),s=n(8716),i=n(670),a=n(7070),d=n(7410),u=n(7630),l=n(7773);class c extends Error{constructor(e,t=400){super(e),this.status=t}}async function p(e,t,n,r,o){let s=await e.getItemById(n);if(!s||s.tenantId!==t)throw new c("Item not found",404);let i=s.allowedUoms.find(e=>e.uom===o)||(s.baseUom===o?{uom:o,toBase:1}:void 0);if(!i)throw new c("Invalid UoM for item");return{item:s,qtyBase:r*i.toBase}}async function I(e,t,n){let{tenantId:r,siteId:o,eventType:s,itemId:i,qtyBase:a,fromLocationId:d,toLocationId:u,reasonCodeId:l}=n;if(r!==t.tenantId)throw new c("Tenant mismatch",403);if(["SCRAP","ADJUST","HOLD"].includes(s)&&!l)throw new c("Reason code is required");let p="ADJUST"===s&&["Admin","Supervisor"].includes(t.role),I=(e,t)=>{if(!e)throw new c(`${t||"Location"} is required`)};if("RECEIVE"===s)I(u,"toLocationId");else if("MOVE"===s)I(d,"fromLocationId"),I(u,"toLocationId");else if("ISSUE_TO_WORKCELL"===s)I(d,"fromLocationId"),I(u,"toLocationId");else if("RETURN"===s)I(d,"fromLocationId"),I(u,"toLocationId");else if("SCRAP"===s)I(d,"fromLocationId");else if("HOLD"===s)I(d,"fromLocationId"),I(u,"toLocationId");else if("RELEASE"===s)I(d,"fromLocationId"),I(u,"toLocationId");else if("COUNT"===s)I(u,"toLocationId");else if("ADJUST"===s&&!d&&!u)throw new c("fromLocationId or toLocationId is required");let m=new Map,f=(e,t)=>{e&&m.set(e,(m.get(e)||0)+t)};switch(s){case"RECEIVE":f(u,a);break;case"MOVE":case"ISSUE_TO_WORKCELL":case"RETURN":case"HOLD":case"RELEASE":case"ADJUST":f(d,-a),f(u,a);break;case"SCRAP":f(d,-a);break;case"COUNT":{if(!u)throw new c("toLocationId is required");let t=await e.getInventoryBalance(r,o,i,u);f(u,a-(t?.qtyBase||0));break}default:throw new c("Unsupported event type")}for(let[t,n]of m.entries()){let s=await e.getInventoryBalance(r,o,i,t);if((s?.qtyBase||0)+n<0&&!p)throw new c("Negative balance prevented")}for(let[t,n]of m.entries()){let s=await e.getInventoryBalance(r,o,i,t),a=(s?.qtyBase||0)+n;await e.upsertInventoryBalance({tenantId:r,siteId:o,itemId:i,locationId:t,qtyBase:a})}return e.createInventoryEvent(n)}var m=n(3887);async function f(e){let t=await (0,l.a8)();if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});if(!["Admin","Supervisor","Inventory"].includes(t.user.role))return a.NextResponse.json({error:"Forbidden"},{status:403});let{searchParams:n}=new URL(e.url),r=n.get("siteId");if(r&&!t.user.siteIds.includes(r))return a.NextResponse.json({error:"Site access denied"},{status:403});let o=await u.t.getInventoryEventsByTenant(t.user.tenantId),s=r?o.filter(e=>e.siteId===r):o;return a.NextResponse.json(s)}async function y(e){try{let t=await (0,l.a8)();if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});let n=m.BQ.parse(await e.json());if(!t.user.siteIds.includes(n.siteId))return a.NextResponse.json({error:"Site access denied"},{status:403});if("ADJUST"===n.eventType&&!["Admin","Supervisor"].includes(t.user.role)||"COUNT"===n.eventType&&!["Admin","Supervisor","Inventory"].includes(t.user.role))return a.NextResponse.json({error:"Permission denied"},{status:403});let r=await u.t.getItemById(n.itemId);if(!r||r.tenantId!==t.user.tenantId)return a.NextResponse.json({error:"Item not found"},{status:404});let o=async e=>{if(!e)return null;let r=await u.t.getLocationById(e);return r&&r.tenantId===t.user.tenantId?r.siteId!==n.siteId?{error:"Location site mismatch"}:null:{error:"Location not found"}},s=await o(n.fromLocationId);if(s)return a.NextResponse.json({error:s.error},{status:400});let i=await o(n.toLocationId);if(i)return a.NextResponse.json({error:i.error},{status:400});if(n.reasonCodeId){let e=await u.t.getReasonCodeById(n.reasonCodeId);if(!e||e.tenantId!==t.user.tenantId)return a.NextResponse.json({error:"Reason code not found"},{status:404});let r=e.type===n.eventType;if(["SCRAP","ADJUST","HOLD"].includes(n.eventType)&&!r)return a.NextResponse.json({error:"Reason code type mismatch"},{status:400})}let{qtyBase:d}=await p(u.t,t.user.tenantId,n.itemId,n.qtyEntered,n.uomEntered),c=await I(u.t,t.sessionUser,{tenantId:t.user.tenantId,siteId:n.siteId,eventType:n.eventType,itemId:n.itemId,qtyEntered:n.qtyEntered,uomEntered:n.uomEntered,qtyBase:d,fromLocationId:n.fromLocationId||null,toLocationId:n.toLocationId||null,workcellId:n.workcellId||null,referenceId:n.referenceId||null,reasonCodeId:n.reasonCodeId||null,notes:n.notes||null,createdByUserId:t.user.id,deviceId:n.deviceId||null});return a.NextResponse.json(c,{status:201})}catch(e){if(e instanceof c)return a.NextResponse.json({error:e.message},{status:e.status});if(e instanceof d.z.ZodError)return a.NextResponse.json({error:"Invalid request",details:e.errors},{status:400});return a.NextResponse.json({error:"Internal server error"},{status:500})}}let v=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/inventory/events/route",pathname:"/api/inventory/events",filename:"route",bundlePath:"app/api/inventory/events/route"},resolvedPagePath:"C:\\Users\\Somli\\OneDrive\\Desktop\\My Apps\\Warehouse Builder\\app\\api\\inventory\\events\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:L,staticGenerationAsyncStorage:R,serverHooks:E}=v,w="/api/inventory/events/route";function g(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:R})}},3887:(e,t,n)=>{n.d(t,{BQ:()=>p,FH:()=>a,Le:()=>u,YJ:()=>d,hJ:()=>i,og:()=>l,yb:()=>c});var r=n(7410);let o=["EA","FT","YD","ROLL"],s=r.z.object({uom:r.z.enum(o),toBase:r.z.number().positive()}),i=r.z.object({sku:r.z.string().min(1),name:r.z.string().min(1),description:r.z.string().optional(),category:r.z.enum(["PRODUCTION","PACKAGING","FACILITY","CHEMICAL_MRO"]),baseUom:r.z.enum(o),allowedUoms:r.z.array(s).min(1),minQtyBase:r.z.number().optional(),maxQtyBase:r.z.number().optional(),reorderPointBase:r.z.number().optional(),leadTimeDays:r.z.number().int().optional()}),a=i.partial(),d=r.z.object({siteId:r.z.string().min(1),zone:r.z.string().optional(),bin:r.z.string().optional(),label:r.z.string().min(1),type:r.z.enum(["RECEIVING","STOCK","WIP","QC_HOLD","SHIPPING"]).optional()}),u=d.partial(),l=r.z.object({type:r.z.enum(["SCRAP","ADJUST","HOLD"]),code:r.z.string().min(1),description:r.z.string().optional()}),c=l.partial(),p=r.z.object({siteId:r.z.string().min(1),eventType:r.z.enum(["RECEIVE","MOVE","ISSUE_TO_WORKCELL","RETURN","SCRAP","HOLD","RELEASE","COUNT","ADJUST"]),itemId:r.z.string().min(1),qtyEntered:r.z.number().positive(),uomEntered:r.z.enum(o),fromLocationId:r.z.string().optional(),toLocationId:r.z.string().optional(),workcellId:r.z.string().optional(),referenceId:r.z.string().optional(),reasonCodeId:r.z.string().optional(),notes:r.z.string().optional(),deviceId:r.z.string().optional()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[276,564,410,773],()=>n(7987));module.exports=r})();